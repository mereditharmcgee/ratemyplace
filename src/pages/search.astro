---
import BaseLayout from '../components/layout/BaseLayout.astro';
import { getDB } from '../lib/db';

const query = Astro.url.searchParams.get('q') || '';
const type = Astro.url.searchParams.get('type') || 'all';

let buildings: any[] = [];
let landlords: any[] = [];

if (query) {
  try {
    const db = getDB((Astro.locals as any).runtime);

    if (type === 'all' || type === 'buildings') {
      const buildingResults = await db.prepare(`
        SELECT b.*, bs.review_count, bs.avg_overall, l.name as landlord_name
        FROM buildings b
        LEFT JOIN building_scores bs ON b.id = bs.building_id
        LEFT JOIN landlords l ON b.landlord_id = l.id
        WHERE b.address LIKE ? OR b.neighborhood LIKE ?
        ORDER BY bs.review_count DESC NULLS LAST
        LIMIT 20
      `).bind(`%${query}%`, `%${query}%`).all();

      buildings = buildingResults.results || [];
    }

    if (type === 'all' || type === 'landlords') {
      const landlordResults = await db.prepare(`
        SELECT l.*, ls.review_count, ls.avg_overall, ls.building_count
        FROM landlords l
        LEFT JOIN landlord_scores ls ON l.id = ls.landlord_id
        WHERE l.name LIKE ?
        ORDER BY ls.review_count DESC NULLS LAST
        LIMIT 20
      `).bind(`%${query}%`).all();

      landlords = landlordResults.results || [];
    }
  } catch (error) {
    console.error('Search error:', error);
  }
}

const hasResults = buildings.length > 0 || landlords.length > 0;
---

<BaseLayout title={query ? `Search: ${query}` : 'Search'}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Search</h1>

    <form action="/search" method="GET" class="mb-8">
      <div class="flex flex-col sm:flex-row gap-4">
        <input
          type="text"
          name="q"
          value={query}
          placeholder="Search by address, neighborhood, or landlord name..."
          class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
        <select
          name="type"
          class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
        >
          <option value="all" selected={type === 'all'}>All</option>
          <option value="buildings" selected={type === 'buildings'}>Buildings</option>
          <option value="landlords" selected={type === 'landlords'}>Landlords</option>
        </select>
        <button
          type="submit"
          class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors"
        >
          Search
        </button>
      </div>
    </form>

    {query && !hasResults && (
      <div class="text-center py-12">
        <div class="text-gray-400 mb-4">
          <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <h2 class="text-xl font-semibold text-gray-900 mb-2">No results found</h2>
        <p class="text-gray-600">
          We couldn't find any buildings or landlords matching "{query}".
        </p>
        <p class="text-gray-600 mt-2">
          Try a different search term or{' '}
          <a href="/review/new" class="text-blue-600 hover:text-blue-800">add a new review</a>
          {' '}for this address.
        </p>
      </div>
    )}

    {buildings.length > 0 && (
      <div class="mb-12">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Buildings ({buildings.length})</h2>
        <div class="grid gap-4">
          {buildings.map((building) => (
            <a
              href={`/building/${building.slug}`}
              class="block bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow"
            >
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="text-lg font-semibold text-gray-900">{building.address}</h3>
                  <p class="text-gray-600">
                    {building.neighborhood && `${building.neighborhood}, `}{building.city}, {building.state}
                  </p>
                  {building.landlord_name && (
                    <p class="text-sm text-gray-500 mt-1">Landlord: {building.landlord_name}</p>
                  )}
                </div>
                <div class="text-right">
                  {building.avg_overall ? (
                    <div>
                      <div class="text-2xl font-bold text-blue-600">{building.avg_overall.toFixed(1)}</div>
                      <div class="text-sm text-gray-500">{building.review_count} review{building.review_count !== 1 ? 's' : ''}</div>
                    </div>
                  ) : (
                    <span class="text-sm text-gray-400">No reviews yet</span>
                  )}
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    )}

    {landlords.length > 0 && (
      <div>
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Landlords ({landlords.length})</h2>
        <div class="grid gap-4">
          {landlords.map((landlord) => (
            <a
              href={`/landlord/${landlord.slug}`}
              class="block bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow"
            >
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="text-lg font-semibold text-gray-900">{landlord.name}</h3>
                  {landlord.building_count > 0 && (
                    <p class="text-gray-600">{landlord.building_count} building{landlord.building_count !== 1 ? 's' : ''}</p>
                  )}
                </div>
                <div class="text-right">
                  {landlord.avg_overall ? (
                    <div>
                      <div class="text-2xl font-bold text-blue-600">{landlord.avg_overall.toFixed(1)}</div>
                      <div class="text-sm text-gray-500">{landlord.review_count} review{landlord.review_count !== 1 ? 's' : ''}</div>
                    </div>
                  ) : (
                    <span class="text-sm text-gray-400">No reviews yet</span>
                  )}
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    )}

    {!query && (
      <div class="text-center py-12 text-gray-600">
        <p>Enter an address, neighborhood, or landlord name to search.</p>
      </div>
    )}
  </div>
</BaseLayout>
