---
import AdminLayout from '../../components/admin/AdminLayout.astro';
import { getDB } from '../../lib/db';

const db = getDB((Astro.locals as any).runtime);

// Get stats
const [
  userStats,
  reviewStats,
  buildingStats,
  landlordStats,
  managerStats,
  verificationStats,
  recentReviews,
] = await Promise.all([
  // User stats
  db.prepare(`
    SELECT
      COUNT(*) as total,
      SUM(CASE WHEN is_admin = 1 THEN 1 ELSE 0 END) as admins,
      SUM(CASE WHEN created_at > unixepoch() - 86400 * 7 THEN 1 ELSE 0 END) as last_week
    FROM users
  `).first(),

  // Review stats
  db.prepare(`
    SELECT
      COUNT(*) as total,
      SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending,
      SUM(CASE WHEN status = 'approved' THEN 1 ELSE 0 END) as approved,
      SUM(CASE WHEN status = 'rejected' THEN 1 ELSE 0 END) as rejected,
      SUM(CASE WHEN is_verified = 1 THEN 1 ELSE 0 END) as verified,
      SUM(CASE WHEN created_at > unixepoch() - 86400 * 7 THEN 1 ELSE 0 END) as last_week
    FROM reviews
  `).first(),

  // Building stats
  db.prepare(`
    SELECT
      COUNT(*) as total,
      SUM(CASE WHEN created_at > unixepoch() - 86400 * 7 THEN 1 ELSE 0 END) as last_week
    FROM buildings
  `).first(),

  // Landlord stats
  db.prepare(`
    SELECT COUNT(*) as total FROM landlords
  `).first(),

  // Property manager stats
  db.prepare(`
    SELECT COUNT(*) as total FROM property_managers
  `).first(),

  // Verification stats
  db.prepare(`
    SELECT
      COUNT(*) as total,
      SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending,
      SUM(CASE WHEN status = 'approved' THEN 1 ELSE 0 END) as approved,
      SUM(CASE WHEN status = 'rejected' THEN 1 ELSE 0 END) as rejected
    FROM verification_images
  `).first(),

  // Recent reviews
  db.prepare(`
    SELECT
      r.id, r.review_title, r.status, r.created_at, r.overall_score,
      u.email as user_email,
      b.address as building_address
    FROM reviews r
    JOIN users u ON r.user_id = u.id
    JOIN buildings b ON r.building_id = b.id
    ORDER BY r.created_at DESC
    LIMIT 5
  `).all(),
]);

const formatDate = (timestamp: number) => {
  return new Date(timestamp * 1000).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    hour: 'numeric',
    minute: '2-digit',
  });
};

const getStatusColor = (status: string) => {
  switch (status) {
    case 'pending': return 'bg-amber-100 text-amber-800';
    case 'approved': return 'bg-green-100 text-green-800';
    case 'rejected': return 'bg-red-100 text-red-800';
    default: return 'bg-gray-100 text-gray-800';
  }
};
---

<AdminLayout title="Admin Dashboard" currentPage="dashboard">
  <div class="space-y-8">
    <!-- Page Header -->
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Dashboard Overview</h1>
      <p class="text-gray-600 mt-1">Welcome to the RateMyPlace admin panel.</p>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <!-- Users -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-500">Total Users</p>
            <p class="text-3xl font-bold text-gray-900 mt-1">{userStats?.total || 0}</p>
          </div>
          <div class="p-3 bg-blue-50 rounded-lg">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
          </div>
        </div>
        <div class="mt-4 flex items-center gap-4 text-sm">
          <span class="text-gray-500">{userStats?.admins || 0} admins</span>
          <span class="text-green-600">+{userStats?.last_week || 0} this week</span>
        </div>
      </div>

      <!-- Reviews -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-500">Total Reviews</p>
            <p class="text-3xl font-bold text-gray-900 mt-1">{reviewStats?.total || 0}</p>
          </div>
          <div class="p-3 bg-amber-50 rounded-lg">
            <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
            </svg>
          </div>
        </div>
        <div class="mt-4 flex items-center gap-4 text-sm">
          <span class="text-amber-600">{reviewStats?.pending || 0} pending</span>
          <span class="text-green-600">{reviewStats?.verified || 0} verified</span>
        </div>
      </div>

      <!-- Buildings -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-500">Buildings</p>
            <p class="text-3xl font-bold text-gray-900 mt-1">{buildingStats?.total || 0}</p>
          </div>
          <div class="p-3 bg-teal-50 rounded-lg">
            <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
          </div>
        </div>
        <div class="mt-4 flex items-center gap-4 text-sm">
          <span class="text-gray-500">{landlordStats?.total || 0} landlords</span>
          <span class="text-gray-500">{managerStats?.total || 0} managers</span>
        </div>
      </div>

      <!-- Verifications -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-500">Verifications</p>
            <p class="text-3xl font-bold text-gray-900 mt-1">{verificationStats?.pending || 0}</p>
          </div>
          <div class="p-3 bg-purple-50 rounded-lg">
            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
        </div>
        <div class="mt-4 text-sm">
          {verificationStats?.pending && Number(verificationStats.pending) > 0 ? (
            <a href="/admin/verify" class="text-purple-600 hover:text-purple-700 font-medium">
              Review {verificationStats.pending} pending →
            </a>
          ) : (
            <span class="text-green-600">All caught up!</span>
          )}
        </div>
      </div>
    </div>

    <!-- Review Status Breakdown -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Review Status -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Review Status Breakdown</h2>
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-3 h-3 rounded-full bg-green-500"></div>
              <span class="text-gray-700">Approved</span>
            </div>
            <span class="font-semibold text-gray-900">{reviewStats?.approved || 0}</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-3 h-3 rounded-full bg-amber-500"></div>
              <span class="text-gray-700">Pending</span>
            </div>
            <span class="font-semibold text-gray-900">{reviewStats?.pending || 0}</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-3 h-3 rounded-full bg-red-500"></div>
              <span class="text-gray-700">Rejected</span>
            </div>
            <span class="font-semibold text-gray-900">{reviewStats?.rejected || 0}</span>
          </div>
        </div>
        <div class="mt-6">
          <a href="/admin/reviews" class="text-teal-600 hover:text-teal-700 text-sm font-medium">
            View all reviews →
          </a>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Recent Reviews</h2>
        {recentReviews.results.length > 0 ? (
          <div class="space-y-3">
            {recentReviews.results.map((review: any) => (
              <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-900 truncate">
                    {review.review_title || review.building_address}
                  </p>
                  <p class="text-xs text-gray-500">
                    {review.user_email} • {formatDate(review.created_at)}
                  </p>
                </div>
                <span class={`px-2 py-1 text-xs font-medium rounded-full ${getStatusColor(review.status)}`}>
                  {review.status}
                </span>
              </div>
            ))}
          </div>
        ) : (
          <p class="text-gray-500 text-sm">No reviews yet.</p>
        )}
        <div class="mt-4">
          <a href="/admin/reviews" class="text-teal-600 hover:text-teal-700 text-sm font-medium">
            View all reviews →
          </a>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <a href="/admin/reviews?status=pending" class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
          <svg class="w-8 h-8 text-amber-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          <span class="text-sm font-medium text-gray-700">Review Pending</span>
        </a>
        <a href="/admin/verify" class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
          <svg class="w-8 h-8 text-purple-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span class="text-sm font-medium text-gray-700">Verify Tenants</span>
        </a>
        <a href="/admin/users" class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
          <svg class="w-8 h-8 text-blue-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
          </svg>
          <span class="text-sm font-medium text-gray-700">Manage Users</span>
        </a>
        <a href="/admin/buildings" class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
          <svg class="w-8 h-8 text-teal-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
          <span class="text-sm font-medium text-gray-700">View Buildings</span>
        </a>
      </div>
    </div>
  </div>
</AdminLayout>
