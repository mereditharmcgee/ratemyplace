---
import StarRating from '../ratings/StarRating.astro';
import { formatFuzzyDate } from '../../lib/privacy';

interface Props {
  review: any;
  showBuilding?: boolean;
}

const { review, showBuilding = false } = Astro.props;

const unitTypeLabels: Record<string, string> = {
  'studio': 'Studio',
  '1br': '1 Bedroom',
  '2br': '2 Bedrooms',
  '3br': '3 Bedrooms',
  '4br+': '4+ Bedrooms',
  'house': 'House'
};

const moveInDate = formatFuzzyDate(review.move_in_year, review.move_in_season);
const moveOutDate = review.is_current_tenant
  ? 'Present'
  : review.move_out_year
    ? formatFuzzyDate(review.move_out_year, review.move_out_season)
    : null;
---

<article class="bg-white border border-gray-200 rounded-lg p-6">
  <div class="flex justify-between items-start mb-4">
    <div>
      {review.review_title && (
        <h3 class="text-lg font-semibold text-gray-900 mb-1">{review.review_title}</h3>
      )}
      <div class="flex items-center gap-2">
        <StarRating rating={review.overall_score || 0} size="sm" />
        <span class="text-sm font-medium text-gray-900">
          {(review.overall_score || 0).toFixed(1)}
        </span>
      </div>
    </div>
    <div class="text-right text-sm text-gray-500">
      <p>{unitTypeLabels[review.unit_type] || review.unit_type}</p>
      <p>{moveInDate}{moveOutDate ? ` - ${moveOutDate}` : ''}</p>
    </div>
  </div>

  {review.review_text && (
    <p class="text-gray-700 mb-4 whitespace-pre-line">{review.review_text}</p>
  )}

  <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm">
    {review.score_building_quality && (
      <div>
        <span class="text-gray-500">Building Quality:</span>
        <span class="ml-1 font-medium">{review.score_building_quality}/5</span>
      </div>
    )}
    {review.score_maintenance && (
      <div>
        <span class="text-gray-500">Maintenance:</span>
        <span class="ml-1 font-medium">{review.score_maintenance}/5</span>
      </div>
    )}
    {review.score_landlord_responsiveness && (
      <div>
        <span class="text-gray-500">Responsiveness:</span>
        <span class="ml-1 font-medium">{review.score_landlord_responsiveness}/5</span>
      </div>
    )}
    {review.score_rent_value && (
      <div>
        <span class="text-gray-500">Value:</span>
        <span class="ml-1 font-medium">{review.score_rent_value}/5</span>
      </div>
    )}
  </div>

  {(review.had_pest_issues || review.had_heat_issues || review.had_water_issues || review.had_security_deposit_issues) && (
    <div class="mt-4 flex flex-wrap gap-2">
      {review.had_pest_issues === 1 && (
        <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">Pest Issues</span>
      )}
      {review.had_heat_issues === 1 && (
        <span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">Heat/Hot Water Issues</span>
      )}
      {review.had_water_issues === 1 && (
        <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Plumbing Issues</span>
      )}
      {review.had_security_deposit_issues === 1 && (
        <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">Deposit Issues</span>
      )}
    </div>
  )}

  <div class="mt-4 pt-4 border-t border-gray-100 flex items-center justify-between text-sm">
    <span class={`px-2 py-1 rounded-full text-xs ${review.would_recommend ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}>
      {review.would_recommend ? 'Would recommend' : 'Would not recommend'}
    </span>
    <span class="text-gray-400">
      Posted {new Date(review.created_at * 1000).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}
    </span>
  </div>
</article>
