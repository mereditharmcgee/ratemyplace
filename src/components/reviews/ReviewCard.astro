---
import StarRating from '../ratings/StarRating.astro';
import VerifiedBadge from '../ui/VerifiedBadge.astro';
import { formatFuzzyDate } from '../../lib/privacy';
import { calculateDomainScores, ITEM_WEIGHTS } from '../../lib/scoring';

interface Props {
  review: any;
  showBuilding?: boolean;
  compact?: boolean;
}

const { review, showBuilding = false, compact = false } = Astro.props;

// Calculate domain sub-scores using the weighted algorithm
const domainScores = calculateDomainScores(review);

const unitTypeLabels: Record<string, string> = {
  'studio': 'Studio',
  '1br': '1 Bedroom',
  '2br': '2 Bedrooms',
  '3br': '3 Bedrooms',
  '4br+': '4+ Bedrooms',
  'house': 'House'
};

// Build unit display string
const unitTypeLabel = unitTypeLabels[review.unit_type] || review.unit_type;
const unitDisplay = review.unit_number
  ? `Unit ${review.unit_number} (${unitTypeLabel})`
  : unitTypeLabel;

const moveInDate = formatFuzzyDate(review.move_in_year, review.move_in_season);
const moveOutDate = review.is_current_tenant
  ? 'Present'
  : review.move_out_year
    ? formatFuzzyDate(review.move_out_year, review.move_out_season)
    : null;

// New score categories based on actual schema
// Items with weight > 1.0 are health/safety critical (marked with indicator)
const unitScores = [
  { key: 'unit_structural', label: 'Structure', weighted: ITEM_WEIGHTS.unit_structural > 1 },
  { key: 'unit_plumbing', label: 'Plumbing', weighted: ITEM_WEIGHTS.unit_plumbing > 1 },
  { key: 'unit_electrical', label: 'Electrical', weighted: ITEM_WEIGHTS.unit_electrical > 1 },
  { key: 'unit_climate', label: 'Climate Control', weighted: ITEM_WEIGHTS.unit_climate > 1 },
  { key: 'unit_ventilation', label: 'Ventilation', weighted: ITEM_WEIGHTS.unit_ventilation > 1 },
  { key: 'unit_pests', label: 'Pest Control', weighted: ITEM_WEIGHTS.unit_pests > 1 },
  { key: 'unit_mold', label: 'Mold/Moisture', weighted: ITEM_WEIGHTS.unit_mold > 1 },
  { key: 'unit_appliances', label: 'Appliances', weighted: ITEM_WEIGHTS.unit_appliances > 1 },
  { key: 'unit_layout', label: 'Layout', weighted: ITEM_WEIGHTS.unit_layout > 1 },
  { key: 'unit_accuracy', label: 'As Advertised', weighted: ITEM_WEIGHTS.unit_accuracy > 1 },
];

const buildingScores = [
  { key: 'building_common_areas', label: 'Common Areas', weighted: ITEM_WEIGHTS.building_common_areas > 1 },
  { key: 'building_security', label: 'Security', weighted: ITEM_WEIGHTS.building_security > 1 },
  { key: 'building_exterior', label: 'Exterior', weighted: ITEM_WEIGHTS.building_exterior > 1 },
  { key: 'building_noise_neighbors', label: 'Neighbor Noise', weighted: ITEM_WEIGHTS.building_noise_neighbors > 1 },
  { key: 'building_noise_external', label: 'External Noise', weighted: ITEM_WEIGHTS.building_noise_external > 1 },
  { key: 'building_mail', label: 'Mail/Packages', weighted: ITEM_WEIGHTS.building_mail > 1 },
  { key: 'building_laundry', label: 'Laundry', weighted: ITEM_WEIGHTS.building_laundry > 1 },
  { key: 'building_parking', label: 'Parking', weighted: ITEM_WEIGHTS.building_parking > 1 },
  { key: 'building_trash', label: 'Trash', weighted: ITEM_WEIGHTS.building_trash > 1 },
];

const landlordScores = [
  { key: 'landlord_maintenance', label: 'Maintenance', weighted: ITEM_WEIGHTS.landlord_maintenance > 1 },
  { key: 'landlord_communication', label: 'Communication', weighted: ITEM_WEIGHTS.landlord_communication > 1 },
  { key: 'landlord_professionalism', label: 'Professionalism', weighted: ITEM_WEIGHTS.landlord_professionalism > 1 },
  { key: 'landlord_lease_clarity', label: 'Lease Clarity', weighted: ITEM_WEIGHTS.landlord_lease_clarity > 1 },
  { key: 'landlord_privacy', label: 'Privacy Respect', weighted: ITEM_WEIGHTS.landlord_privacy > 1 },
  { key: 'landlord_deposit', label: 'Deposit Handling', weighted: ITEM_WEIGHTS.landlord_deposit > 1 },
  { key: 'landlord_rent_practices', label: 'Rent Practices', weighted: ITEM_WEIGHTS.landlord_rent_practices > 1 },
  { key: 'landlord_non_retaliation', label: 'Non-Retaliation', weighted: ITEM_WEIGHTS.landlord_non_retaliation > 1 },
];

function getScoreColor(score: number): string {
  if (score >= 4) return 'text-green-600';
  if (score >= 3) return 'text-yellow-600';
  if (score >= 2) return 'text-orange-600';
  return 'text-red-600';
}

// Filter to only scores that exist
const availableUnitScores = unitScores.filter(s => review[s.key] != null);
const availableBuildingScores = buildingScores.filter(s => review[s.key] != null);
const availableLandlordScores = landlordScores.filter(s => review[s.key] != null);

// Security deposit display helpers
const hasDepositScore = review.landlord_deposit != null;
const hasDepositIssues = review.had_security_deposit_issues === 1;
const showDepositSection = hasDepositScore || hasDepositIssues;

function getDepositStatus(score: number): { label: string; color: string; bgColor: string } {
  if (score >= 4) return { label: 'Good', color: 'text-green-700', bgColor: 'bg-green-50 border-green-200' };
  if (score >= 3) return { label: 'Fair', color: 'text-yellow-700', bgColor: 'bg-yellow-50 border-yellow-200' };
  return { label: 'Concerning', color: 'text-red-700', bgColor: 'bg-red-50 border-red-200' };
}

const depositStatus = hasDepositScore ? getDepositStatus(review.landlord_deposit) : null;

// Parse JSON arrays safely
function parseJsonArray(value: string | null | undefined): string[] {
  if (!value) return [];
  try {
    const parsed = JSON.parse(value);
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
}

const amenities = parseJsonArray(review.amenities);
const utilitiesIncluded = parseJsonArray(review.utilities_included);
const petTypes = parseJsonArray(review.pet_types);

// Labels for amenities
const amenityLabels: Record<string, string> = {
  'pet_friendly': 'Pet Friendly',
  'laundry_in_unit': 'In-Unit Laundry',
  'laundry_in_building': 'Building Laundry',
  'dishwasher': 'Dishwasher',
  'air_conditioning': 'A/C',
  'parking': 'Parking',
  'gym': 'Gym',
  'pool': 'Pool',
  'doorman': 'Doorman',
  'elevator': 'Elevator',
  'storage': 'Storage',
  'bike_storage': 'Bike Storage',
  'roof_deck': 'Roof Deck',
  'outdoor_space': 'Outdoor Space',
};

// Labels for utilities
const utilityLabels: Record<string, string> = {
  'heat': 'Heat',
  'hot_water': 'Hot Water',
  'electricity': 'Electric',
  'gas': 'Gas',
  'water': 'Water',
  'trash': 'Trash',
  'internet': 'Internet',
  'cable': 'Cable',
};

// Labels for laundry types
const laundryLabels: Record<string, string> = {
  'in_unit': 'In-Unit',
  'in_building': 'In Building',
  'coin_op': 'Coin-Op',
  'none': 'None',
};

// Labels for parking types
const parkingLabels: Record<string, string> = {
  'included': 'Included',
  'available': 'Available (Extra)',
  'street': 'Street Only',
  'none': 'None',
};
---

<article class="bg-white border border-gray-200 rounded-lg p-6">
  <!-- Header -->
  <div class="flex justify-between items-start mb-4">
    <div>
      {review.review_title && (
        <h3 class="text-lg font-semibold text-gray-900 mb-1">{review.review_title}</h3>
      )}
      <div class="flex items-center gap-2 mb-2">
        <StarRating rating={domainScores.overall || review.overall_score || 0} size="sm" />
        <span class="text-sm font-medium text-gray-900">
          {(domainScores.overall || review.overall_score || 0).toFixed(1)}
        </span>
        <span class="text-xs text-gray-400">overall</span>
      </div>
      <!-- Domain Sub-Scores -->
      {(domainScores.unit || domainScores.building || domainScores.landlord) && (
        <div class="flex flex-wrap gap-2">
          {domainScores.unit && (
            <span class={`px-2 py-0.5 text-xs font-medium rounded ${domainScores.unit >= 4 ? 'bg-emerald-100 text-emerald-700' : domainScores.unit >= 3 ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}`}>
              Unit: {domainScores.unit.toFixed(1)}
            </span>
          )}
          {domainScores.building && (
            <span class={`px-2 py-0.5 text-xs font-medium rounded ${domainScores.building >= 4 ? 'bg-emerald-100 text-emerald-700' : domainScores.building >= 3 ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}`}>
              Building: {domainScores.building.toFixed(1)}
            </span>
          )}
          {domainScores.landlord && (
            <span class={`px-2 py-0.5 text-xs font-medium rounded ${domainScores.landlord >= 4 ? 'bg-emerald-100 text-emerald-700' : domainScores.landlord >= 3 ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}`}>
              Landlord: {domainScores.landlord.toFixed(1)}
            </span>
          )}
        </div>
      )}
    </div>
    <div class="text-right text-sm text-gray-500">
      <p class="font-medium text-gray-700">{unitDisplay}</p>
      <p>{moveInDate}{moveOutDate ? ` - ${moveOutDate}` : ''}</p>
      {review.rent_amount && (
        <p class="text-teal-600 font-medium">${review.rent_amount.toLocaleString()}/mo</p>
      )}
    </div>
  </div>

  <!-- Review Text / Comments -->
  {(review.review_text || review.comments) && (
    <p class="text-gray-700 mb-4 whitespace-pre-line">{review.review_text || review.comments}</p>
  )}

  <!-- Unit Details -->
  {(review.bedrooms || review.bathrooms || review.square_footage) && (
    <div class="flex flex-wrap gap-3 mb-4 text-sm">
      {review.bedrooms && (
        <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded">
          {review.bedrooms} bed{review.bedrooms !== '1' ? 's' : ''}
        </span>
      )}
      {review.bathrooms && (
        <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded">
          {review.bathrooms} bath{review.bathrooms !== '1' ? 's' : ''}
        </span>
      )}
      {review.square_footage && (
        <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded">
          {review.square_footage} sq ft
        </span>
      )}
    </div>
  )}

  <!-- Score Breakdown Grid -->
  {(availableUnitScores.length > 0 || availableBuildingScores.length > 0 || availableLandlordScores.length > 0) && (
    <div class="bg-gray-50 rounded-lg p-4 mb-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Unit Scores -->
        {availableUnitScores.length > 0 && (
          <div>
            <div class="flex items-center gap-2 mb-2">
              <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Unit Condition</h4>
              {domainScores.unit && (
                <span class={`text-xs font-bold ${domainScores.unit >= 4 ? 'text-emerald-600' : domainScores.unit >= 3 ? 'text-amber-600' : 'text-red-600'}`}>
                  {domainScores.unit.toFixed(1)}
                </span>
              )}
            </div>
            <div class="space-y-1">
              {availableUnitScores.map(({ key, label, weighted }) => (
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600">
                    {label}
                    {weighted && <span class="text-red-400 ml-0.5" title="Health/Safety weighted">*</span>}
                  </span>
                  <span class={`font-medium ${getScoreColor(review[key])}`}>{review[key]}/5</span>
                </div>
              ))}
            </div>
          </div>
        )}

        <!-- Building Scores -->
        {availableBuildingScores.length > 0 && (
          <div>
            <div class="flex items-center gap-2 mb-2">
              <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Building</h4>
              {domainScores.building && (
                <span class={`text-xs font-bold ${domainScores.building >= 4 ? 'text-emerald-600' : domainScores.building >= 3 ? 'text-amber-600' : 'text-red-600'}`}>
                  {domainScores.building.toFixed(1)}
                </span>
              )}
            </div>
            <div class="space-y-1">
              {availableBuildingScores.map(({ key, label, weighted }) => (
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600">
                    {label}
                    {weighted && <span class="text-red-400 ml-0.5" title="Health/Safety weighted">*</span>}
                  </span>
                  <span class={`font-medium ${getScoreColor(review[key])}`}>{review[key]}/5</span>
                </div>
              ))}
            </div>
          </div>
        )}

        <!-- Landlord Scores -->
        {availableLandlordScores.length > 0 && (
          <div>
            <div class="flex items-center gap-2 mb-2">
              <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Landlord</h4>
              {domainScores.landlord && (
                <span class={`text-xs font-bold ${domainScores.landlord >= 4 ? 'text-emerald-600' : domainScores.landlord >= 3 ? 'text-amber-600' : 'text-red-600'}`}>
                  {domainScores.landlord.toFixed(1)}
                </span>
              )}
            </div>
            <div class="space-y-1">
              {availableLandlordScores.map(({ key, label, weighted }) => (
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600">
                    {label}
                    {weighted && <span class="text-red-400 ml-0.5" title="Health/Safety weighted">*</span>}
                  </span>
                  <span class={`font-medium ${getScoreColor(review[key])}`}>{review[key]}/5</span>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  )}

  <!-- Security Deposit Highlight -->
  {showDepositSection && (
    <div class={`rounded-lg p-4 mb-4 border ${hasDepositIssues ? 'bg-amber-50 border-amber-300' : depositStatus?.bgColor || 'bg-gray-50 border-gray-200'}`}>
      <div class="flex items-center gap-3">
        <div class="shrink-0">
          <svg class={`w-6 h-6 ${hasDepositIssues ? 'text-amber-600' : depositStatus?.color || 'text-gray-500'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="flex-1">
          <div class="flex items-center justify-between">
            <h4 class={`text-sm font-semibold uppercase tracking-wide ${hasDepositIssues ? 'text-amber-800' : depositStatus?.color || 'text-gray-700'}`}>
              Security Deposit
            </h4>
            {hasDepositScore && (
              <div class="flex items-center gap-2">
                <div class="flex gap-0.5">
                  {[1, 2, 3, 4, 5].map(i => (
                    <div class={`w-3 h-3 rounded-sm ${i <= review.landlord_deposit ? (review.landlord_deposit >= 4 ? 'bg-green-500' : review.landlord_deposit >= 3 ? 'bg-yellow-500' : 'bg-red-500') : 'bg-gray-200'}`} />
                  ))}
                </div>
                <span class={`text-sm font-bold ${depositStatus?.color}`}>{review.landlord_deposit}/5</span>
              </div>
            )}
          </div>
          {hasDepositIssues && (
            <p class="text-sm text-amber-700 mt-1 flex items-center gap-1">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
              </svg>
              Tenant reported issues with security deposit return
            </p>
          )}
          {hasDepositScore && !hasDepositIssues && (
            <p class={`text-sm mt-1 ${depositStatus?.color}`}>
              {review.landlord_deposit >= 4 ? 'Deposit handled fairly' : review.landlord_deposit >= 3 ? 'Mixed experience with deposit' : 'Problems with deposit handling'}
            </p>
          )}
        </div>
      </div>
    </div>
  )}

  <!-- Amenities & Utilities -->
  {(amenities.length > 0 || utilitiesIncluded.length > 0 || review.laundry_type || review.parking_type) && (
    <div class="bg-blue-50 rounded-lg p-4 mb-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <!-- Utilities Included -->
        {utilitiesIncluded.length > 0 && (
          <div>
            <h4 class="text-xs font-semibold text-blue-700 uppercase tracking-wide mb-2">Utilities Included</h4>
            <div class="flex flex-wrap gap-1">
              {utilitiesIncluded.map(util => (
                <span class="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded-full">
                  {utilityLabels[util] || util}
                </span>
              ))}
            </div>
          </div>
        )}

        <!-- Amenities -->
        {amenities.length > 0 && (
          <div>
            <h4 class="text-xs font-semibold text-blue-700 uppercase tracking-wide mb-2">Amenities</h4>
            <div class="flex flex-wrap gap-1">
              {amenities.map(amenity => (
                <span class="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded-full">
                  {amenityLabels[amenity] || amenity}
                </span>
              ))}
            </div>
          </div>
        )}

        <!-- Laundry & Parking -->
        {(review.laundry_type || review.parking_type) && (
          <div class="sm:col-span-2 flex flex-wrap gap-4 text-sm">
            {review.laundry_type && (
              <span class="text-gray-600">
                <strong>Laundry:</strong> {laundryLabels[review.laundry_type] || review.laundry_type}
                {review.laundry_wash_cost && review.laundry_dry_cost && (
                  <span class="text-gray-500"> (${review.laundry_wash_cost} wash / ${review.laundry_dry_cost} dry)</span>
                )}
              </span>
            )}
            {review.parking_type && (
              <span class="text-gray-600">
                <strong>Parking:</strong> {parkingLabels[review.parking_type] || review.parking_type}
              </span>
            )}
          </div>
        )}
      </div>
    </div>
  )}

  <!-- Pets -->
  {petTypes.length > 0 && (
    <div class="flex flex-wrap gap-2 mb-4">
      <span class="text-sm text-gray-600 font-medium">Pets allowed:</span>
      {petTypes.map(pet => (
        <span class="px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full capitalize">
          {pet}
        </span>
      ))}
    </div>
  )}

  <!-- Issues Tags -->
  {(review.had_pest_issues === 1 || review.had_heat_issues === 1 || review.had_water_issues === 1 || review.had_security_deposit_issues === 1 || review.had_pests === 1) && (
    <div class="flex flex-wrap gap-2 mb-4">
      <span class="text-sm text-gray-600 font-medium">Issues reported:</span>
      {(review.had_pest_issues === 1 || review.had_pests === 1) && (
        <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">Pest Issues</span>
      )}
      {review.had_heat_issues === 1 && (
        <span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">Heat/Hot Water Issues</span>
      )}
      {review.had_water_issues === 1 && (
        <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Plumbing Issues</span>
      )}
      {review.had_security_deposit_issues === 1 && (
        <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">Deposit Issues</span>
      )}
    </div>
  )}

  <!-- Footer -->
  <div class="mt-4 pt-4 border-t border-gray-100 flex items-center justify-between text-sm">
    <div class="flex items-center gap-3">
      <span class={`px-2 py-1 rounded-full text-xs ${review.would_recommend === 1 || review.would_recommend_new === 'yes' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}>
        {review.would_recommend === 1 || review.would_recommend_new === 'yes' ? 'Would recommend' : 'Would not recommend'}
      </span>
      {review.is_verified === 1 && <VerifiedBadge size="sm" />}
    </div>
    <span class="text-gray-400">
      Posted {new Date(review.created_at * 1000).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}
    </span>
  </div>
</article>
